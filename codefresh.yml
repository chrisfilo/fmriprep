version: '1.0'
steps:
  build_image:
    type: build
    description: Building the image ...
    image_name: poldracklab/fmriprep
    tag: develop # ${{CF_BRANCH}}

  download_test_data:
    image: ${{build_image}}
    description: Downloading test data...
    environment:
      - DS005_URL="https://files.osf.io/v1/resources/fvuh8/providers/osfstorage/57f32a429ad5a101f977eb75"
      - DS005_FS_URL="https://files.osf.io/v1/resources/fvuh8/providers/osfstorage/58fe59eb594d900250960180"
      - DS054_URL="https://files.osf.io/v1/resources/fvuh8/providers/osfstorage/57f32c22594d9001ef91bf9e"
    commands:
      - mkdir -p ${{CF_VOLUME_PATH}}/data
      - mkdir -p ${{CF_VOLUME_PATH}}/ds005/out
      - mkdir -p ${{CF_VOLUME_PATH}}/ds054
      - mkdir -p ${{CF_VOLUME_PATH}}/docs
      - >- 
        bash -c 'if [[ ! -d ${{CF_VOLUME_PATH}}/data/ds005 ]]; 
          then curl -sSL ${DS005_URL} | tar xz -C ${{CF_VOLUME_PATH}}/data/; 
        fi'
      - >- 
        bash -c 'if [[ ! -d ${{CF_VOLUME_PATH}}/data/ds054 ]]; 
          then curl -sSL ${DS054_URL} | tar xz -C ${{CF_VOLUME_PATH}}/data/; 
        fi'
      - >- 
        bash -c 'if [[ ! -d ${{CF_VOLUME_PATH}}/data/freesurfer ]]; 
          then curl -sSL ${DS005_FS_URL} | tar xz -C ${{CF_VOLUME_PATH}}/data/; 
        fi'
  basic_test:
    image: ${{build_image}}
    description: Checking if --version runs ...
    commands:
      - fmriprep --version